# EMC Auditor Plugin Configuration
# KiCad PCB EMC Compliance Rules
# Last Updated: 2026-02-06

[general]
# Plugin metadata
plugin_name = "EMC Auditor"
version = "1.2.0"
description = "Electromagnetic Compatibility verification for PCB designs"

# Layer for drawing violation markers
marker_layer = "Cmts.User"
marker_circle_radius_mm = 0.8
marker_line_width_mm = 0.1
marker_text_offset_mm = 1.2
marker_text_size_mm = 0.5

# Grouped violations for easy deletion: right-click marker → "Select Items in Group" → Delete

# Debug output: true = detailed report + file save, false = summary only
verbose_logging = true

# ======================================================================
# VIA STITCHING RULES
# ======================================================================
[via_stitching]
enabled = false  # Disabled for focused creepage testing
description = "Verifies that critical signal vias have nearby GND return vias"

# Maximum distance from critical via to nearest GND via (mm)
max_distance_mm = 2.0

# Net classes that require via stitching verification
critical_net_classes = ["HighSpeed", "Clock", "Differential"]

# Net name patterns that identify ground vias (case-insensitive)
ground_net_patterns = ["GND", "GROUND", "VSS", "PGND", "AGND"]

# Violation message template
violation_message = "NO GND VIA"

# ======================================================================
# DECOUPLING CAPACITOR RULES
# ======================================================================
[decoupling]
enabled = false  # Disabled for focused creepage testing
description = "Verifies proximity of decoupling capacitors to IC power pins"

# Maximum distance from IC power pin to nearest capacitor (mm)
max_distance_mm = 3.0

# Component reference prefixes that require decoupling verification
# (typically ICs: microcontrollers, logic chips, etc.)
ic_reference_prefixes = ["U"]

# Capacitor reference prefixes to search for
capacitor_reference_prefixes = ["C"]

# Power net patterns (auto-excluded from EMI checks, require decoupling instead)
power_net_patterns = ["VCC", "VDD", "PWR", "3V3", "5V", "1V8", "2V5", "12V", "+3V3", "+5V"]

violation_message = "CAP TOO FAR ({distance:.1f}mm)"

draw_arrow_to_nearest_cap = true  # Draw arrow from IC pin to nearest cap
show_capacitor_label = true       # Show cap reference (e.g., "→ C15")

# Matches capacitors on same power net only (VCC pin → VCC capacitors)

# ======================================================================
# TRACE WIDTH RULES (Future Implementation)
# ======================================================================
[trace_width]
enabled = false 
description = "Verifies minimum trace widths for high-current nets"

# Minimum trace width for power traces (mm)
power_trace_min_width_mm = 0.5

# Power net patterns
power_net_patterns = ["VCC", "VDD", "PWR", "3V3", "5V"]

# Current capacity rules (A per mm width)
current_per_width = 1.0  # 1A per 1mm width for external layers

violation_message = "TRACE TOO NARROW"

# ======================================================================
# GROUND PLANE RULES - High-Speed Signal Return Path Verification
# ======================================================================
[ground_plane]
enabled = false  # Disabled for focused creepage testing
description = "Verifies continuous ground plane underneath high-speed traces for proper return path and EMC compliance"

# Net classes requiring ground plane verification (high-speed signals)
# These signals need continuous return path for signal integrity and low EMI
critical_net_classes = ["HighSpeed", "Clock", "Differential", "USB", "Ethernet"]

# Ground plane layer patterns (net names identifying ground planes)
ground_net_patterns = ["GND", "GROUND", "VSS", "PGND", "AGND", "DGND"]

# ======================================================================
# GROUND PLANE CONTINUITY CHECK (underneath traces)
# ======================================================================
# Verifies unbroken ground plane beneath high-speed traces (signal return path, EMI reduction)

check_continuity_under_trace = true
max_gap_under_trace_mm = 0.5  # Max allowed gap in ground plane
sampling_interval_mm = 0.5  # Check interval along trace

ground_plane_check_layers = "all"  # "adjacent" = layer below, "all" = all ground layers

violation_message_no_ground = "NO GND PLANE UNDER TRACE"

# ======================================================================
# GROUND PLANE CLEARANCE CHECK (around traces)
# ======================================================================
# Verifies ground plane surrounds high-speed trace ("moat" for EMC compliance)

check_clearance_around_trace = true
min_clearance_around_trace_mm = 1.0  # Ground plane must be within this distance
max_ground_gap_in_clearance_zone_mm = 2.0  # Max gap in return path "moat"
check_both_sides = true

violation_message_insufficient_clearance = "INSUFFICIENT GND AROUND TRACE"

# ======================================================================
# GROUND PLANE COVERAGE (global check)
# ======================================================================
check_global_coverage = false
min_coverage_percent = 30.0
max_gap_anywhere_mm = 5.0

violation_message_global = "GND PLANE GAP"

# ======================================================================
# ADVANCED PARAMETERS
# ======================================================================

# Ignore violations near vias/pads (ground vias break plane locally)
ignore_via_clearance = 0.5  # mm
ignore_pad_clearance = 0.3  # mm
min_ground_polygon_area_mm2 = 10.0  # Ignore small copper islands

preferred_ground_layers = ["GND", "Bottom", "Inner2"]  # Layer priority


# ======================================================================
# DIFFERENTIAL PAIR RULES (Future Implementation)
# ======================================================================
[differential_pairs]
enabled = false
description = "Verifies differential pair matching and spacing"

# Maximum length mismatch between pairs (mm)
max_length_mismatch_mm = 0.5

# Target differential impedance (Ohms)
target_impedance_ohm = 100.0

# Tolerance percentage
tolerance_percent = 10.0

violation_message = "DIFF PAIR MISMATCH"

# ======================================================================
# HIGH-SPEED SIGNAL RULES (Future Implementation)
# ======================================================================
[high_speed]
enabled = false
description = "Verifies high-speed signal routing best practices"

# Maximum stub length for high-speed signals (mm)
max_stub_length_mm = 0.5

# Minimum bend radius (mm)
min_bend_radius_mm = 0.5

# Net classes to check
net_classes = ["HighSpeed", "Clock", "USB", "HDMI", "Ethernet"]

violation_message = "HIGH-SPEED VIOLATION"

# ======================================================================
# EMI FILTERING RULES
# ======================================================================
[emi_filtering]
enabled = false  # Disabled for focused creepage testing
description = "Verifies EMI filtering on interface connectors (USB, Ethernet, HDMI, CAN, RS485)"

# Connector identification - components with this reference prefix
# Example: J1, J2, J3, etc.
connector_prefix = "J"

# Filter component prefixes to search for
# R = Resistor, L = Inductor, FB = Ferrite Bead, C = Capacitor, D = Diode (TVS)
filter_component_prefixes = ["R", "L", "FB", "C", "D"]

# Maximum distance from connector to filter components (mm)
# Components beyond this distance won't be considered part of the filter
max_filter_distance_mm = 10.0

# Minimum required filter type (hierarchy: Pi > T > LC > RC > L > C > R > simple)
# Options:
#   "Pi"     - Pi filter: Shunt-Series-Shunt topology
#              LC variant: C-L-C or C-FB-C (Best EMI suppression, bidirectional)
#              RC variant: C-R-C (Basic filtering with impedance matching)
#   "T"      - T filter: Series-Shunt-Series topology
#              LC variant: L-C-L or FB-C-FB (Good EMI suppression, series impedance)
#              RC variant: R-C-R (Basic filtering, lossy but effective termination)
#   "LC"     - LC filter (series inductor + shunt capacitor) - Good for power/signal lines
#   "RC"     - RC filter (series resistor + shunt capacitor) - Basic filtering, lossy
#   "L"      - Single series inductor or ferrite bead - Minimal filtering
#   "C"      - Single shunt capacitor to ground - Minimal filtering
#   "R"      - Single series resistor - Not recommended (lossy, no EMI filtering)
#   "simple" - Any component present - Accepts anything
#
# TOPOLOGY DETECTION:
#   - Series component: Both pads connected to signal net (in signal path)
#   - Shunt component: One pad on signal, other pad on GND/power (bypass to ground)
#   - Pi filter: Shunt → Series → Shunt (e.g., C22 to GND, R in line, C23 to GND)
#   - T filter: Series → Shunt → Series (e.g., R1 in line, C to GND, R2 in line)
min_filter_type = "LC"

# Violation message shown on marker
violation_message = "MISSING EMI FILTER"

# ======================================================================
# FILTER TOPOLOGY CLASSIFICATION CONFIGURATION
# ======================================================================

# Component class mapping (for topology analysis)
# Maps component reference prefix to functional class
[emi_filtering.component_classes]
inductor_prefixes = ["L", "FB"]  # Ferrite beads (FB) are treated as inductors
capacitor_prefixes = ["C"]
resistor_prefixes = ["R"]
diode_prefixes = ["D"]  # TVS diodes

# Ground and power net patterns (for series/shunt detection)
# Components with one pad on signal and other on these nets are classified as "shunt"
# Components with both pads on signal net are classified as "series"
#
# EXAMPLES:
#   Series component: R1 pad 1 → NET_A, R1 pad 2 → NET_A (resistor in signal path)
#   Shunt component:  C1 pad 1 → NET_A, C1 pad 2 → GND (capacitor to ground)
#   
#   LC Pi filter:     C1 (shunt to GND) → L1 (series in line) → C2 (shunt to GND)
#   RC Pi filter:     C1 (shunt to GND) → R1 (series in line) → C2 (shunt to GND)
#   LC T filter:      L1 (series in line) → C1 (shunt to GND) → L2 (series in line)
ground_patterns = ["GND", "GROUND", "VSS", "AGND", "DGND", "PGND", "EARTH"]
power_patterns = ["VCC", "VDD", "PWR", "+", "VBUS", "3V3", "5V", "1V8", "2V5", "12V", "+3V3", "+5V"]

# Differential pair net patterns (common-mode choke: 4+ pins, common-mode cap: 2 pins)
[emi_filtering.differential_pairs]
patterns = [
    ["_P", "_N"],      # Generic: SIGNAL_P / SIGNAL_N
    ["_p", "_n"],      # Lowercase variant
    ["+", "-"],        # Generic: SIGNAL+ / SIGNAL-
    ["DP", "DM"],      # USB: USB_DP / USB_DM
    ["dp", "dm"],      # Lowercase USB
    ["TXP", "TXN"],    # Ethernet TX: ETH_TXP / ETH_TXN
    ["txp", "txn"],    # Lowercase
    ["RXP", "RXN"],    # Ethernet RX: ETH_RXP / ETH_RXN
    ["rxp", "rxn"],    # Lowercase
    ["CANH", "CANL"],  # CAN bus: CAN_CANH / CAN_CANL
    ["canh", "canl"],  # Lowercase CAN
    ["LINE_P", "LINE_N"]  # Generic: LINE_P / LINE_N (10BASE-T1S Ethernet)
]

min_common_mode_choke_pins = 4  # Common-mode chokes: 4 pins typical

# ======================================================================
# CLEARANCE AND CREEPAGE RULES - IEC60664-1 / IPC2221
# ======================================================================
[clearance_creepage]
enabled = true
description = "Verifies clearance/creepage distances per IEC60664-1/IPC2221"
standard = "IEC60664-1"  # "IEC60664-1", "IPC2221", or "BOTH"

# Overvoltage category: I (electronics), II (appliances), III (distribution), IV (utility)
overvoltage_category = "II"

# Pollution degree: 1 (clean), 2 (condensation), 3 (conductive), 4 (continuous wet)
pollution_degree = 2

# Material group: I (CTI≥600), II (CTI 400-599, FR4), IIIa (CTI 175-399), IIIb (CTI 100-174)
material_group = "II"

altitude_m = 1000  # >2000m needs clearance increase
internal_layer_clearance_factor = 0.6  # 0.5-0.6 typical (substrate protection)
overvoltage_category_factors = { I = 0.8, II = 1.0, III = 1.5, IV = 2.0 }

# ======================================================================
# CHECKING PARAMETERS
# ======================================================================

# Check types
check_clearance = true  # Air gap distance
check_creepage = true  # Surface distance (A* pathfinding)
check_different_layers = false  # NOT YET IMPLEMENTED

min_trace_spacing_mm = 0.2  # Trace-to-trace minimum
min_pad_spacing_mm = 0.3  # Pad-to-pad minimum
safety_margin_factor = 1.2  # Safety multiplier (1.2 = 20% margin)
report_mode = "violations_only"  # or "all_distances"

# Creepage pathfinding: <100 obstacles=Visibility Graph (optimal), ≥100=Fast A* (faster)
max_obstacles = 270  # Observed max: 261
obstacle_search_margin_mm = 12.0  # Spatial filter radius
# Speed tuning: reduce max_obstacles (270→150) or margin_mm (12→10) for 2× faster
# "No path found" often means PCB slots/cutouts physically separate domains (expected)

# Violation message templates
violation_message_clearance = "CLEARANCE: {actual:.2f}mm < {required:.2f}mm ({domainA}-{domainB})"
violation_message_creepage = "CREEPAGE: {actual:.2f}mm < {required:.2f}mm ({domainA}-{domainB})"

# IEC60664-1 Clearance Tables (OVC-II, PD2, auto-adjusted for other OVC)
# Format: [voltage_rms, clearance_mm]

[[clearance_creepage.iec60664_clearance_table]]
voltage_class = "Extra Extra Low Voltage (Functional Spacing)"
note = "IPC2221: <12V functional spacing, minimum fab capability"
voltages = [
    [0.0, 0.13],    # 0V - Minimum PCB fab capability (5 mil / 0.13mm)
    [3.3, 0.13],    # 3.3V - Standard logic level (IPC2221: 0-30V)
    [5.0, 0.13],    # 5V - USB, TTL logic (IPC2221: 0-30V)
]

[[clearance_creepage.iec60664_clearance_table]]
voltage_class = "Extra Low Voltage (ELV/SELV)"
note = "SELV ≤50V: Safety Extra Low Voltage, safe to touch"
voltages = [
    [12.0, 0.5],    # 12V RMS - Automotive, industrial
    [24.0, 0.5],    # 24V RMS - Industrial automation, PoE
    [50.0, 0.6],    # 50V RMS (SELV upper limit)
]

[[clearance_creepage.iec60664_clearance_table]]
voltage_class = "Low Voltage (LV)"
note = "100V and above: Industrial/utility voltages"
voltages = [
    [100.0, 1.0],   # 100V RMS
    [150.0, 1.5],   # 150V RMS
    [230.0, 2.5],   # 230V RMS (EU mains)
    [300.0, 3.0],   # 300V RMS
    [400.0, 4.0],   # 400V RMS (3-phase)
]

[[clearance_creepage.iec60664_clearance_table]]
voltage_class = "High Voltage (HV)"
voltages = [
    [600.0, 5.5],   # 600V RMS
    [800.0, 8.0],   # 800V RMS
    [1000.0, 10.0], # 1000V RMS
]

# ======================================================================
# CREEPAGE DISTANCE TABLES (IEC60664-1)
# ======================================================================
# Depends on: voltage (RMS/DC), Material Group (CTI), Pollution Degree
# Material: I (CTI≥600 best), II (CTI 400-599 FR4), IIIa (CTI 175-399), IIIb (CTI 100-174 worst)
# Pollution: PD1 (clean), PD2 (typical, condensation), PD3 (conductive), PD4 (continuous wet)
# Format: [voltage_rms, creepage_mm]

# ----------------------------------------------------------------------
# Material Group I (CTI ≥ 600) - Best insulation (PTFE, ceramics)
# ----------------------------------------------------------------------
[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group I"
pollution = "Pollution Degree 1"
note = "Clean environment, best material (PTFE, ceramics)"
voltages = [
    [12.0, 0.2],      # 12V RMS
    [24.0, 0.25],     # 24V RMS
    [50.0, 0.4],      # 50V RMS
    [100.0, 0.63],    # 100V RMS
    [150.0, 0.9],     # 150V RMS
    [230.0, 1.25],    # 230V RMS (EU mains)
    [300.0, 1.6],     # 300V RMS
    [400.0, 2.0],     # 400V RMS
    [600.0, 2.8],     # 600V RMS
    [800.0, 3.75],    # 800V RMS
    [1000.0, 5.0],    # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group I"
pollution = "Pollution Degree 2"
note = "Typical environment, best material"
voltages = [
    [12.0, 0.25],     # 12V RMS
    [24.0, 0.32],     # 24V RMS
    [50.0, 0.5],      # 50V RMS
    [100.0, 0.8],     # 100V RMS
    [150.0, 1.12],    # 150V RMS
    [230.0, 1.6],     # 230V RMS (EU mains)
    [300.0, 2.0],     # 300V RMS
    [400.0, 2.5],     # 400V RMS
    [600.0, 3.55],    # 600V RMS
    [800.0, 4.75],    # 800V RMS
    [1000.0, 6.3],    # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group I"
pollution = "Pollution Degree 3"
note = "Harsh environment (conductive pollution), best material"
voltages = [
    [12.0, 0.4],      # 12V RMS
    [24.0, 0.5],      # 24V RMS
    [50.0, 0.8],      # 50V RMS
    [100.0, 1.25],    # 100V RMS
    [150.0, 1.8],     # 150V RMS
    [230.0, 2.5],     # 230V RMS (EU mains)
    [300.0, 3.2],     # 300V RMS
    [400.0, 4.0],     # 400V RMS
    [600.0, 5.6],     # 600V RMS
    [800.0, 7.5],     # 800V RMS
    [1000.0, 10.0],   # 1000V RMS
]

# ----------------------------------------------------------------------
# Material Group II (CTI 400-599) - Standard FR4 PCB material
# ----------------------------------------------------------------------
[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group II"
pollution = "Pollution Degree 1"
note = "Clean environment, standard FR4"
voltages = [
    [12.0, 0.25],     # 12V RMS
    [24.0, 0.32],     # 24V RMS
    [50.0, 0.5],      # 50V RMS
    [100.0, 0.8],     # 100V RMS
    [150.0, 1.12],    # 150V RMS
    [230.0, 1.6],     # 230V RMS (EU mains)
    [300.0, 2.0],     # 300V RMS
    [400.0, 2.5],     # 400V RMS
    [600.0, 3.55],    # 600V RMS
    [800.0, 4.75],    # 800V RMS
    [1000.0, 6.3],    # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group II"
pollution = "Pollution Degree 2"
note = "TYPICAL: Standard office/industrial environment with FR4"
voltages = [
    [12.0, 0.4],      # 12V RMS
    [24.0, 0.5],      # 24V RMS
    [50.0, 0.8],      # 50V RMS
    [100.0, 1.25],    # 100V RMS
    [150.0, 1.8],     # 150V RMS
    [230.0, 2.5],     # 230V RMS (EU mains)
    [300.0, 3.2],     # 300V RMS
    [400.0, 4.0],     # 400V RMS
    [600.0, 5.6],     # 600V RMS
    [800.0, 7.5],     # 800V RMS
    [1000.0, 10.0],   # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group II"
pollution = "Pollution Degree 3"
note = "Harsh environment (conductive pollution), standard FR4"
voltages = [
    [12.0, 0.63],     # 12V RMS
    [24.0, 0.8],      # 24V RMS
    [50.0, 1.25],     # 50V RMS
    [100.0, 2.0],     # 100V RMS
    [150.0, 2.8],     # 150V RMS
    [230.0, 4.0],     # 230V RMS (EU mains)
    [300.0, 5.0],     # 300V RMS
    [400.0, 6.3],     # 400V RMS
    [600.0, 9.0],     # 600V RMS
    [800.0, 12.0],    # 800V RMS
    [1000.0, 16.0],   # 1000V RMS
]

# ----------------------------------------------------------------------
# Material Group IIIa (CTI 175-399) - Lower grade materials
# ----------------------------------------------------------------------
[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIa"
pollution = "Pollution Degree 1"
note = "Clean environment, lower grade material"
voltages = [
    [12.0, 0.4],      # 12V RMS
    [24.0, 0.5],      # 24V RMS
    [50.0, 0.8],      # 50V RMS
    [100.0, 1.25],    # 100V RMS
    [150.0, 1.8],     # 150V RMS
    [230.0, 2.5],     # 230V RMS (EU mains)
    [300.0, 3.2],     # 300V RMS
    [400.0, 4.0],     # 400V RMS
    [600.0, 5.6],     # 600V RMS
    [800.0, 7.5],     # 800V RMS
    [1000.0, 10.0],   # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIa"
pollution = "Pollution Degree 2"
note = "Typical environment, lower grade material"
voltages = [
    [12.0, 0.63],     # 12V RMS
    [24.0, 0.8],      # 24V RMS
    [50.0, 1.25],     # 50V RMS
    [100.0, 2.0],     # 100V RMS
    [150.0, 2.8],     # 150V RMS
    [230.0, 4.0],     # 230V RMS (EU mains)
    [300.0, 5.0],     # 300V RMS
    [400.0, 6.3],     # 400V RMS
    [600.0, 9.0],     # 600V RMS
    [800.0, 12.0],    # 800V RMS
    [1000.0, 16.0],   # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIa"
pollution = "Pollution Degree 3"
note = "Harsh environment, lower grade material"
voltages = [
    [12.0, 1.0],      # 12V RMS
    [24.0, 1.25],     # 24V RMS
    [50.0, 2.0],      # 50V RMS
    [100.0, 3.2],     # 100V RMS
    [150.0, 4.5],     # 150V RMS
    [230.0, 6.3],     # 230V RMS (EU mains)
    [300.0, 8.0],     # 300V RMS
    [400.0, 10.0],    # 400V RMS
    [600.0, 14.0],    # 600V RMS
    [800.0, 19.0],    # 800V RMS
    [1000.0, 25.0],   # 1000V RMS
]

# ----------------------------------------------------------------------
# Material Group IIIb (CTI 100-174) - Poor insulation (avoid if possible)
# ----------------------------------------------------------------------
[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIb"
pollution = "Pollution Degree 1"
note = "Clean environment, poor material (NOT RECOMMENDED)"
voltages = [
    [12.0, 0.63],     # 12V RMS
    [24.0, 0.8],      # 24V RMS
    [50.0, 1.25],     # 50V RMS
    [100.0, 2.0],     # 100V RMS
    [150.0, 2.8],     # 150V RMS
    [230.0, 4.0],     # 230V RMS (EU mains)
    [300.0, 5.0],     # 300V RMS
    [400.0, 6.3],     # 400V RMS
    [600.0, 9.0],     # 600V RMS
    [800.0, 12.0],    # 800V RMS
    [1000.0, 16.0],   # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIb"
pollution = "Pollution Degree 2"
note = "Typical environment, poor material (NOT RECOMMENDED)"
voltages = [
    [12.0, 1.0],      # 12V RMS
    [24.0, 1.25],     # 24V RMS
    [50.0, 2.0],      # 50V RMS
    [100.0, 3.2],     # 100V RMS
    [150.0, 4.5],     # 150V RMS
    [230.0, 6.3],     # 230V RMS (EU mains)
    [300.0, 8.0],     # 300V RMS
    [400.0, 10.0],    # 400V RMS
    [600.0, 14.0],    # 600V RMS
    [800.0, 19.0],    # 800V RMS
    [1000.0, 25.0],   # 1000V RMS
]

[[clearance_creepage.iec60664_creepage_table]]
material = "Material Group IIIb"
pollution = "Pollution Degree 3"
note = "Harsh environment, poor material (NOT RECOMMENDED)"
voltages = [
    [12.0, 1.6],      # 12V RMS
    [24.0, 2.0],      # 24V RMS
    [50.0, 3.2],      # 50V RMS
    [100.0, 5.0],     # 100V RMS
    [150.0, 7.1],     # 150V RMS
    [230.0, 10.0],    # 230V RMS (EU mains)
    [300.0, 12.5],    # 300V RMS
    [400.0, 16.0],    # 400V RMS
    [600.0, 22.0],    # 600V RMS
    [800.0, 30.0],    # 800V RMS
    [1000.0, 40.0],   # 1000V RMS
]

# ======================================================================
# IPC2221 CLEARANCE/CREEPAGE TABLES (Alternative Standard)
# ======================================================================

# IPC2221 does not differentiate between clearance and creepage
# The spacing values apply to both air gap (clearance) and surface path (creepage)
# Values are more conservative than IEC60664-1 for some voltage ranges
# Based on IPC2221 Table 6-1: Conductor Spacing

# IPC2221 Table 6-1: External Layers (B1-B6) - Uncoated
# Use these values when PCB is not conformally coated
[[clearance_creepage.ipc2221_spacing_table]]
layer_type = "External (B1-B6)"
condition = "Uncoated"
note = "For uncoated external layers, applies to both clearance and creepage"
voltages = [
    [0.0, 0.13],      # 0-15V DC (5 mil minimum fab capability)
    [30.0, 0.13],     # 16-30V DC
    [50.0, 0.13],     # 31-50V DC (SELV range)
    [100.0, 0.25],    # 51-100V DC (10 mil)
    [150.0, 0.4],     # 101-150V DC
    [170.0, 0.5],     # 151-170V DC (20 mil)
    [250.0, 0.8],     # 171-250V DC (mains range)
    [300.0, 0.8],     # 251-300V DC
    [500.0, 1.5],     # 301-500V DC (60 mil)
]

# IPC2221 Table 6-1: External Layers (B1-B6) - Coated
# Conformal coating allows reduced spacing
[[clearance_creepage.ipc2221_spacing_table]]
layer_type = "External (B1-B6)"
condition = "Coated (Conformal)"
note = "For conformally coated external layers, reduced spacing allowed"
voltages = [
    [0.0, 0.13],      # 0-15V DC (5 mil - no reduction)
    [30.0, 0.13],     # 16-30V DC
    [50.0, 0.13],     # 31-50V DC (SELV range)
    [100.0, 0.13],    # 51-100V DC (coating provides insulation)
    [150.0, 0.13],    # 101-150V DC
    [170.0, 0.13],    # 151-170V DC
    [250.0, 0.4],     # 171-250V DC (mains range)
    [300.0, 0.4],     # 251-300V DC
    [500.0, 0.8],     # 301-500V DC
]

# IPC2221 Table 6-1: Internal Layers (B2-B4) - Embedded in substrate
# Internal layers inherently "coated" by PCB laminate
[[clearance_creepage.ipc2221_spacing_table]]
layer_type = "Internal (B2-B4)"
condition = "Embedded"
note = "For internal layers embedded in PCB substrate"
voltages = [
    [0.0, 0.1],       # 0-15V DC (4 mil)
    [30.0, 0.1],      # 16-30V DC
    [50.0, 0.1],      # 31-50V DC (SELV range)
    [100.0, 0.2],     # 51-100V DC (8 mil)
    [150.0, 0.32],    # 101-150V DC
    [170.0, 0.4],     # 151-170V DC
    [250.0, 0.6],     # 171-250V DC (mains range)
    [300.0, 0.6],     # 251-300V DC
    [500.0, 1.27],    # 301-500V DC (50 mil)
]

# IPC2221 Table 6-2: AC Voltage Peak Conversion
# For AC voltages, use peak voltage (RMS × 1.414) to look up spacing
# Example: 230V AC RMS = 325V peak → use 300-500V range
[[clearance_creepage.ipc2221_ac_conversion]]
note = "AC voltage handling"
conversion = "voltage_peak = voltage_rms × 1.414"
example = "230V AC RMS = 325V peak → use 300-500V range from table"

# ======================================================================
# VOLTAGE DOMAIN DEFINITIONS
# ======================================================================
# Define voltage domains on your PCB for clearance/creepage checking
# Use KiCad Net Classes (preferred) or net_patterns (fallback)
# Each domain: name, description, voltage_rms, net_patterns, requires_reinforced_insulation
#
[[clearance_creepage.voltage_domains]]
name = "MAINS_L"
description = "AC Mains Live (230V)"
voltage_rms = 230
net_patterns = ["AC_L", "MAINS_L", "L_MAINS", "LINE"]
requires_reinforced_insulation = true

[[clearance_creepage.voltage_domains]]
name = "MAINS_N"
description = "AC Mains Neutral"
voltage_rms = 0
net_patterns = ["AC_N", "MAINS_N", "N_MAINS", "NEUTRAL"]

[[clearance_creepage.voltage_domains]]
name = "HIGH_VOLTAGE_DC"
description = "High voltage DC bus (400V)"
voltage_rms = 400
net_patterns = ["HV+", "HV-", "HVDC", "400V"]
requires_reinforced_insulation = true

[[clearance_creepage.voltage_domains]]
name = "LOW_VOLTAGE_DC"
description = "Low voltage DC (12-48V)"
voltage_rms = 24
net_patterns = ["12V", "24V", "48V", "+12V", "+24V", "+48V"]

[[clearance_creepage.voltage_domains]]
name = "EXTRA_LOW_VOLTAGE"
description = "Extra low voltage / SELV (≤50V)"
voltage_rms = 5
net_patterns = ["3V3", "5V", "12V", "+3V3", "+5V", "VCC", "VDD"]

[[clearance_creepage.voltage_domains]]
name = "GROUND"
description = "Ground / chassis reference"
voltage_rms = 0
net_patterns = ["GND", "GROUND", "PGND", "AGND", "DGND", "CHASSIS", "PE"]

# ======================================================================
# SAFETY ISOLATION REQUIREMENTS
# ======================================================================
# Define isolation levels for specific domain pairs
[[clearance_creepage.isolation_requirements]]
domain_a = "MAINS_L"
domain_b = "EXTRA_LOW_VOLTAGE"
isolation_type = "reinforced"
min_clearance_mm = 6.0
min_creepage_mm = 8.0
description = "Mains to SELV - Reinforced"

[[clearance_creepage.isolation_requirements]]
domain_a = "HIGH_VOLTAGE_DC"
domain_b = "LOW_VOLTAGE_DC"
isolation_type = "basic"
min_clearance_mm = 4.0
min_creepage_mm = 5.0
description = "HV to LV"

[[clearance_creepage.isolation_requirements]]
domain_a = "MAINS_L"
domain_b = "GROUND"
isolation_type = "basic"
min_clearance_mm = 2.5
min_creepage_mm = 3.2
description = "Mains to Ground"

# ======================================================================
# IMPLEMENTATION NOTES
# ======================================================================
# Algorithm: Parse voltage_domains, calculate clearance (3D air gap) and creepage (surface path)
# Requirements: isolation_requirements or IEC60664/IPC2221 tables, apply safety_margin_factor
# Advanced: Detect slots/cutouts, conformal coating, isolation barriers, temperature derating

# ======================================================================
# SIGNAL INTEGRITY RULES
# ======================================================================
[signal_integrity.impedance]
enabled = true
description = "Controlled impedance verification using analytical transmission line formulas"

# Target impedances per KiCad Net Class (ohms)
# Net Class names from KiCad design → target impedance
target_impedance_by_class = { USB = 90.0, HDMI = 100.0, DDR = 50.0, HighSpeed = 50.0 }

# Impedance tolerance (ohms) - applied to all net classes
# Example: USB 90Ω ± 5Ω → acceptable range 85-95Ω, HighSpeed 50Ω ± 5Ω → 45-55Ω
impedance_tolerance_ohms = 5.0

# Calculation method: Analytical formulas (IPC-2141, Wadell)
# - Microstrip: External layer with plane below
# - Stripline: Internal layer between planes
# - CPW: Coplanar waveguide with/without plane
# Accuracy: ±5-10% (sufficient for DRC, much faster than FEM)

# Stackup data is automatically read from the .kicad_pcb file (stackup section)
# Falls back to FR-4 defaults (35μm copper, εr=4.3) if parsing fails
